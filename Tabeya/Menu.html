<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - Tabeya Restaurant</title>
    <link rel="stylesheet" href="CSS/Menu.css">
</head>

<body>

    <header>
        <div class="logo">
            <img src="Photo/Tabeya Name.png" alt="Tabeya Logo">
        </div>
        <nav class="nav-links">
            <a href="Home.html">HOME</a>
            <a href="Menu.html" class="active">MENU</a>
            <a href="#" id="cater-reservation-link">CATER RESERVATION</a>
            <a href="Review.php">TESTIMONY</a>
            <a href="About.html">ABOUT</a>
        </nav>
        <div class="header-right">
            <a href="Login.html" id="account-link">PROFILE</a>
            <div class="cart-icon" id="view-cart-btn">
                üõí <span class="cart-count" id="cart-item-count">0</span>
            </div>
        </div>
    </header>

    <!-- Best Sellers Section -->
    <section class="bestsellers-section">
        <h2>BEST SELLERS</h2>
        <div id="bestsellers-content" class="bestsellers-grid">
            <p style="text-align: center; padding: 50px; color: white;">Loading best sellers...</p>
        </div>
    </section>

    <section class="menu-section">
        <h2>OUR MENU</h2>
        <div id="dynamic-menu-content">
            <p style="text-align: center; padding: 50px; color: white;">Loading menu items...</p>
        </div>
    </section>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Your Cart</h2>
            <div id="cart-items-list">
            </div>
            <div class="cart-summary">
                <strong>Total: ‚Ç±<span id="cart-total">0.00</span></strong>
            </div>
            <button id="checkout-btn">Proceed to Checkout</button>
        </div>
    </div>

    <footer>
        <div class="contact-section">
            <div class="container">
                <div class="contact-info">
                    <h2>Contact Us</h2>
                    <p>Have any questions? We'd love to hear from you.</p>
                    <div class="info-group">
                        <div class="info-item visit-us">
                            <img src="Photo/VisitUs.png" alt="Location Icon" class="icon">
                            <div>
                                <strong>Visit us</strong>
                                <p>Poblacion 2, Vinzons Avenue,<br>Vinzons, Camarines Norte</p>
                            </div>
                        </div>
                        <div class="info-item call-us">
                            <img src="Photo/Selpon.png" alt="Phone Icon" class="icon">
                            <div>
                                <strong>Call us</strong>
                                <p>09380839641</p>
                            </div>
                        </div>
                        <div class="info-item connect-us">
                            <img src="Photo/Facebook.png" alt="Facebook Icon" class="icon">
                            <div>
                                <strong>Connect to us</strong>
                                <a href="https://www.facebook.com/profile.php?id=100063540027038" target="_blank"
                                    class="no-underline">Tabeya, VCN</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ====================================================================
        // === CONFIGURATION & DATA ===
        // ====================================================================
        const CART_KEY = 'tabeyaCart';
        const USER_KEY = 'currentUser';
        const LOGIN_PAGE = 'Login.html';
        const CATER_RESERVATION_PAGE = 'CaterReservation.html';
        const PROFILE_PAGE = 'Profile.html';

        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];

        // --- Core Login Check ---
        function checkUserLoginStatus() {
            return localStorage.getItem(USER_KEY) !== null;
        }

        function checkLoginAndProceed(redirectTarget) {
            if (!checkUserLoginStatus()) {
                alert("You must log in to perform this action.");
                if (redirectTarget) {
                    localStorage.setItem('redirectAfterLogin', redirectTarget);
                }
                window.location.href = LOGIN_PAGE;
                return false;
            }
            if (redirectTarget && redirectTarget !== 'Menu.html') {
                window.location.href = redirectTarget;
            }
            return true;
        }

        // ====================================================================
        // === DATA FETCHING LOGIC ===
        // ====================================================================

        function groupProductsByCategory(products) {
            return products.reduce((acc, product) => {
                const category = product.Category;
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(product);
                return acc;
            }, {});
        }

        async function fetchMenuData() {
            console.log("Fetching menu data from fetch_products.php...");
            const container = document.getElementById('dynamic-menu-content');

            try {
                const response = await fetch('fetch_products.php');

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    allProducts = result.products;
                    renderBestSellers(allProducts);
                    renderMenu(allProducts);
                    console.log(`Successfully loaded ${result.count} products.`);
                } else {
                    console.error('Server Error:', result.message);
                    container.innerHTML = `
                        <p style="text-align: center; color: yellow; font-weight: bold; padding: 50px;">
                            ERROR: Failed to load menu. ${result.message}
                        </p>`;
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                container.innerHTML = `
                    <p style="text-align: center; color: yellow; font-weight: bold; padding: 50px;">
                        Could not connect to the server. Please try again later.
                    </p>`;
            }
        }

        // ====================================================================
        // === STAR RATING GENERATION ===
        // ====================================================================

        function generateStarRating(starRating, orderCount) {
            let starsHtml = '<div class="star-rating">';

            // Generate 5 stars
            for (let i = 1; i <= 5; i++) {
                if (i <= starRating) {
                    starsHtml += '<span class="star filled">‚òÖ</span>';
                } else {
                    starsHtml += '<span class="star">‚òÖ</span>';
                }
            }

            // Calculate average rating display (star rating * 1.0 for display)
            const ratingDisplay = starRating > 0 ? `(${starRating}.0)` : '(0.0)';
            starsHtml += `<span class="rating-number">${ratingDisplay}</span>`;
            starsHtml += '</div>';

            return starsHtml;
        }

        // ====================================================================
        // === CART MANAGEMENT LOGIC ===
        // ====================================================================

        function updateCartDisplay() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-item-count').textContent = count;
        }

        function saveCart() {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
            updateCartDisplay();
            if (document.getElementById('cart-modal').style.display === "block") {
                renderCartModal();
            }
        }

        function addToCart(itemDetails) {
            if (!checkUserLoginStatus()) {
                alert("You must log in to add items to cart.");
                localStorage.setItem('redirectAfterLogin', 'Menu.html');
                window.location.href = LOGIN_PAGE;
                return;
            }

            // Check if product is available
            if (!itemDetails.available) {
                alert(`Sorry, ${itemDetails.name} is currently out of stock.`);
                return;
            }

            const existingItem = cart.find(item => String(item.id) === String(itemDetails.id));

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: itemDetails.id,
                    name: itemDetails.name,
                    price: itemDetails.price,
                    quantity: 1,
                    stockStatus: itemDetails.stockStatus
                });
            }

            saveCart();
            alert(`${itemDetails.name} added to cart!`);
        }

        window.updateCartItemQuantity = function (itemId, change) {
            if (!checkUserLoginStatus()) {
                alert("You must log in to modify the cart.");
                return;
            }

            const itemIndex = cart.findIndex(item => String(item.id) === String(itemId));
            if (itemIndex > -1) {
                cart[itemIndex].quantity += change;
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1);
                }
                saveCart();
            }
        }

        function calculateTotal() {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0).toFixed(2);
        }

        // ====================================================================
        // === RENDERING FUNCTIONS ===
        // ====================================================================

        function renderCartModal() {
            const listContainer = document.getElementById('cart-items-list');
            const totalElement = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            let itemsHtml = '';

            if (cart.length === 0) {
                itemsHtml = '<p style="text-align: center; color: #777; padding: 15px 0;">Your cart is empty.</p>';
                checkoutBtn.disabled = true;
            } else {
                // Check if any items are out of stock
                const hasOutOfStock = cart.some(item =>
                    item.stockStatus === 'out_of_stock' || item.stockStatus === 'low_stock'
                );

                cart.forEach(item => {
                    const itemTotal = (item.price * item.quantity).toFixed(2);
                    const safeId = String(item.id).replace(/'/g, "\\'");

                    // Add warning for out of stock items
                    const stockWarning = (item.stockStatus === 'out_of_stock' || item.stockStatus === 'low_stock')
                        ? '<span style="color: red; font-size: 0.8em;">‚ö†Ô∏è Unavailable</span>'
                        : '';

                    itemsHtml += `
                        <div class="cart-item">
                            <div class="cart-item-info"> 
                                <span class="cart-item-name">${item.name} ${stockWarning}</span>
                                <span class="cart-item-price">‚Ç±${parseFloat(item.price).toFixed(2)} ea.</span>
                            </div>
                            
                            <div class="cart-item-controls">
                                <button onclick="window.updateCartItemQuantity('${safeId}', -1)">-</button>
                                <span class="cart-item-quantity">${item.quantity}</span> 
                                <button onclick="window.updateCartItemQuantity('${safeId}', 1)">+</button>
                            </div>
                            
                            <span class="cart-item-subtotal">‚Ç±${itemTotal}</span> 
                        </div>
                    `;
                });

                // Disable checkout if any items are unavailable
                if (hasOutOfStock) {
                    checkoutBtn.disabled = true;
                    itemsHtml += '<p style="color: red; text-align: center; padding: 10px;">‚ö†Ô∏è Some items are unavailable. Please remove them to checkout.</p>';
                } else {
                    checkoutBtn.disabled = false;
                }
            }

            listContainer.innerHTML = itemsHtml;
            totalElement.textContent = calculateTotal();
        }

        function renderBestSellers(products) {
            const container = document.getElementById('bestsellers-content');
            if (!container) return;

            // Sort products by OrderCount (descending) and take top 6
            const bestSellers = [...products]
                .sort((a, b) => (b.OrderCount || 0) - (a.OrderCount || 0))
                .slice(0, 6);

            if (bestSellers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: white; padding: 20px;">No best sellers available.</p>';
                return;
            }

            let html = '';

            bestSellers.forEach(item => {
                const id = item.ProductID;
                const name = item.ProductName;
                const priceDisplay = parseFloat(item.Price).toFixed(2);
                const rawPrice = item.Price;
                const imagePath = item.Image;
                const description = item.Description || '';
                const starRating = item.StarRating || 0;
                const orderCount = item.OrderCount || 0;
                const stockStatus = item.StockStatus || 'available';
                const isAvailable = item.IngredientAvailable;

                // Determine stock badge
                let stockBadge = '';
                let stockClass = '';
                if (stockStatus === 'out_of_stock') {
                    stockBadge = '<span class="stock-badge out-of-stock">Out of Stock</span>';
                    stockClass = 'out-of-stock';
                } else if (stockStatus === 'low_stock') {
                    stockBadge = '<span class="stock-badge low-stock">Low Stock</span>';
                    stockClass = 'low-stock';
                }

                // Generate star rating HTML
                const starsHtml = generateStarRating(starRating, orderCount);

                // Button text and state
                const buttonDisabled = !isAvailable ? 'disabled' : '';
                const buttonText = !isAvailable ? 'Unavailable' : 'Add to Cart';

                html += `
                    <div class="menu-item2 ${stockClass}" data-item-id="${id}"> 
                        ${stockBadge}
                        <div class="item-image-container">
                            <img 
                                src="${imagePath}" 
                                alt="${name}" 
                                class="item-image"
                                onerror="this.onerror=null; this.src='Photo/default-image.jpg';" 
                            >
                        </div>
                        <div class="item-details-container">
                            <div class="item-info2">
                                <div class="item-name">${name}</div>
                                ${starsHtml}
                                <div class="item-description">${description}</div>
                                <div class="item-price">‚Ç±${priceDisplay}</div>
                            </div>
                            <button class="add-to-cart-btn" 
                                data-id="${id}" 
                                data-name="${name}" 
                                data-price="${rawPrice}"
                                data-available="${isAvailable}"
                                data-stock-status="${stockStatus}"
                                ${buttonDisabled}>
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            setupBestSellersListeners();
        }

        function renderMenu(products) {
            const container = document.getElementById('dynamic-menu-content');
            if (!container) return;

            let menuHtml = '';

            const groupedProducts = groupProductsByCategory(products);

            container.innerHTML = '';

            for (const categoryName in groupedProducts) {
                menuHtml += `
                    <div class="menu-category-container menu-category">
                        <h3>${categoryName}</h3>
                        <div class="menu-grid2">
                `;

                groupedProducts[categoryName].forEach(item => {
                    const id = item.ProductID;
                    const name = item.ProductName;
                    const priceDisplay = parseFloat(item.Price).toFixed(2);
                    const rawPrice = item.Price;
                    const imagePath = item.Image;
                    const description = item.Description || '';
                    const starRating = item.StarRating || 0;
                    const orderCount = item.OrderCount || 0;
                    const stockStatus = item.StockStatus || 'available';
                    const isAvailable = item.IngredientAvailable;

                    // Determine stock badge
                    let stockBadge = '';
                    let stockClass = '';
                    if (stockStatus === 'out_of_stock') {
                        stockBadge = '<span class="stock-badge out-of-stock">Out of Stock</span>';
                        stockClass = 'out-of-stock';
                    } else if (stockStatus === 'low_stock') {
                        stockBadge = '<span class="stock-badge low-stock">Low Stock</span>';
                        stockClass = 'low-stock';
                    }

                    // Generate star rating HTML
                    const starsHtml = generateStarRating(starRating, orderCount);

                    // Button text and state
                    const buttonDisabled = !isAvailable ? 'disabled' : '';
                    const buttonText = !isAvailable ? 'Unavailable' : 'Add to Cart';

                    menuHtml += `
                        <div class="menu-item2 ${stockClass}" data-item-id="${id}"> 
                            ${stockBadge}
                            <div class="item-image-container">
                                <img 
                                    src="${imagePath}" 
                                    alt="${name}" 
                                    class="item-image"
                                    onerror="this.onerror=null; this.src='Photo/default-image.jpg';" 
                                >
                            </div>
                            <div class="item-details-container">
                                <div class="item-info2">
                                    <div class="item-name">${name}</div>
                                    ${starsHtml}
                                    <div class="item-description">${description}</div>
                                    <div class="item-price">‚Ç±${priceDisplay}</div>
                                </div>
                                <button class="add-to-cart-btn" 
                                    data-id="${id}" 
                                    data-name="${name}" 
                                    data-price="${rawPrice}"
                                    data-available="${isAvailable}"
                                    data-stock-status="${stockStatus}"
                                    ${buttonDisabled}>
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    `;
                });

                menuHtml += `
                        </div>
                    </div>
                `;
            }

            container.innerHTML = menuHtml;
            setupMenuListeners();
        }

        function updateAccountLink() {
            const accountLink = document.getElementById('account-link');
            const user = JSON.parse(localStorage.getItem(USER_KEY));

            if (user) {
                accountLink.textContent = user.name.split(' ')[0].toUpperCase();
                accountLink.href = PROFILE_PAGE;
            } else {
                accountLink.textContent = 'PROFILE';
                accountLink.href = LOGIN_PAGE;
            }
        }

        // ====================================================================
        // === EVENT LISTENERS ===
        // ====================================================================
        function setupBestSellersListeners() {
            document.querySelectorAll('#bestsellers-content .add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const name = e.target.getAttribute('data-name');
                    const price = parseFloat(e.target.getAttribute('data-price'));
                    const available = e.target.getAttribute('data-available') === 'true';
                    const stockStatus = e.target.getAttribute('data-stock-status');

                    addToCart({ id, name, price, available, stockStatus });
                });
            });
        }

        function setupMenuListeners() {
            document.querySelectorAll('#dynamic-menu-content .add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const name = e.target.getAttribute('data-name');
                    const price = parseFloat(e.target.getAttribute('data-price'));
                    const available = e.target.getAttribute('data-available') === 'true';
                    const stockStatus = e.target.getAttribute('data-stock-status');

                    addToCart({ id, name, price, available, stockStatus });
                });
            });
        }

        function setupGlobalListeners() {
            const modal = document.getElementById('cart-modal');
            const btn = document.getElementById("view-cart-btn");
            const span = document.getElementsByClassName("close-btn")[0];
            const checkoutBtn = document.getElementById('checkout-btn');

            btn.onclick = function () {
                if (checkLoginAndProceed('Menu.html')) {
                    renderCartModal();
                    modal.style.display = "block";
                }
            }

            span.onclick = function () {
                modal.style.display = "none";
            }

            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            checkoutBtn.addEventListener('click', () => {
                if (cart.length > 0) {
                    // Verify all items are available before checkout
                    const hasUnavailable = cart.some(item =>
                        item.stockStatus === 'out_of_stock' || item.stockStatus === 'low_stock'
                    );

                    if (hasUnavailable) {
                        alert("Some items in your cart are unavailable. Please remove them before checkout.");
                        return;
                    }

                    if (checkLoginAndProceed('Checkout.html')) {
                        // Redirect handled inside checkLoginAndProceed
                    }
                } else {
                    alert("Your cart is empty!");
                }
            });

            const caterLink = document.getElementById('cater-reservation-link');
            if (caterLink) {
                caterLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    checkLoginAndProceed(CATER_RESERVATION_PAGE);
                });
            }
        }

        // ====================================================================
        // === INITIALIZATION ===
        // ====================================================================

        function updateHeaderElements() {
            updateCartDisplay();
            updateAccountLink();
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchMenuData();
            updateHeaderElements();
            setupGlobalListeners();
        });
    </script>
</body>

</html>