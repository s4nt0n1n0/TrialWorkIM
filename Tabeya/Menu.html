<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - Tabeya Restaurant</title>
    <link rel="stylesheet" href="CSS/Menu.css">
    <link rel="stylesheet" href="CSS/Footer.css">
</head>

<body>

    <header>
        <div class="logo">
            <img src="Photo/Tabeya Name.png" alt="Tabeya Logo">
        </div>
        <nav class="nav-links">
            <a href="Home.html">HOME</a>
            <a href="Menu.html" class="active">MENU</a>
            <a href="#" id="cater-reservation-link">CATER RESERVATION</a>
            <a href="Review.php">TESTIMONY</a>
            <a href="About.html">ABOUT</a>
        </nav>
        <div class="header-right">
            <a href="Login.html" id="account-link">PROFILE</a>
            <div class="cart-icon" id="view-cart-btn">
                <a href="Cart.html" style="text-decoration: none; color: inherit;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span class="cart-count" id="cart-item-count">0</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Best Sellers Section -->
    <section class="bestsellers-section">
        <h2>BEST SELLERS</h2>
        <div id="bestsellers-content" class="bestsellers-grid">
            <p style="text-align: center; padding: 50px; color: white;">Loading best sellers...</p>
        </div>
    </section>

    <section class="menu-section">
        <h2>OUR MENU</h2>
        <div id="dynamic-menu-content">
            <p style="text-align: center; padding: 50px; color: white;">Loading menu items...</p>
        </div>
    </section>

    <!-- Cart Modal Removed -->

    <footer>
        <div class="contact-section">
            <div class="contact-info">
                <h2>Contact Us</h2>
                <p>Have any questions? We'd love to hear from you.</p>
                <div class="contact-grid">
                    <div class="contact-item">
                        <img src="Photo/VisitUs.png" alt="Location">
                        <div class="contact-item-text">
                            <strong>Visit us</strong>
                            <p>Poblacion 2, Vinzons Avenue,<br>Vinzons, CN</p>
                        </div>
                    </div>
                    <div class="contact-item">
                        <img src="Photo/Selpon.png" alt="Phone">
                        <div class="contact-item-text">
                            <strong>Call us</strong>
                            <p>09380839641</p>
                        </div>
                    </div>
                    <div class="contact-item">
                        <img src="Photo/Facebook.png" alt="Facebook">
                        <div class="contact-item-text">
                            <strong>Connect</strong>
                            <p><a href="https://www.facebook.com/profile.php?id=100063540027038" target="_blank">Tabeya,
                                    VCN</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ====================================================================
        // === CONFIGURATION & DATA ===
        // ====================================================================
        const CART_KEY = 'tabeyaCart';
        const USER_KEY = 'currentUser';
        const LOGIN_PAGE = 'Login.html';
        const CATER_RESERVATION_PAGE = 'CaterReservation.html';
        const PROFILE_PAGE = 'Profile.html';

        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];

        // --- Core Login Check ---
        function checkUserLoginStatus() {
            return localStorage.getItem(USER_KEY) !== null;
        }

        function checkLoginAndProceed(redirectTarget) {
            if (!checkUserLoginStatus()) {
                alert("You must log in to perform this action.");
                if (redirectTarget) {
                    localStorage.setItem('redirectAfterLogin', redirectTarget);
                }
                window.location.href = LOGIN_PAGE;
                return false;
            }
            if (redirectTarget && redirectTarget !== 'Menu.html') {
                window.location.href = redirectTarget;
            }
            return true;
        }

        // ====================================================================
        // === DATA FETCHING LOGIC ===
        // ====================================================================

        function groupProductsByCategory(products) {
            return products.reduce((acc, product) => {
                const category = product.Category;
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(product);
                return acc;
            }, {});
        }

        async function fetchMenuData() {
            console.log("Fetching menu data from fetch_products.php...");
            const container = document.getElementById('dynamic-menu-content');

            try {
                const response = await fetch('fetch_products.php');

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    allProducts = result.products;
                    renderBestSellers(allProducts);
                    renderMenu(allProducts);
                    console.log(`Successfully loaded ${result.count} products.`);
                } else {
                    console.error('Server Error:', result.message);
                    container.innerHTML = `
                        <p style="text-align: center; color: yellow; font-weight: bold; padding: 50px;">
                            ERROR: Failed to load menu. ${result.message}
                        </p>`;
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                container.innerHTML = `
                    <p style="text-align: center; color: yellow; font-weight: bold; padding: 50px;">
                        Could not connect to the server. Please try again later.
                    </p>`;
            }
        }

        // ====================================================================
        // === STAR RATING GENERATION ===
        // ====================================================================

        function generateStarRating(starRating, orderCount) {
            let starsHtml = '<div class="star-rating">';

            // Generate 5 stars
            for (let i = 1; i <= 5; i++) {
                if (i <= starRating) {
                    starsHtml += '<span class="star filled">★</span>';
                } else {
                    starsHtml += '<span class="star">★</span>';
                }
            }

            // Calculate average rating display (star rating * 1.0 for display)
            const ratingDisplay = starRating > 0 ? `(${starRating}.0)` : '(0.0)';
            starsHtml += `<span class="rating-number">${ratingDisplay}</span>`;

            // Add Total Orders Display
            starsHtml += `</div><div class="order-count-label">${orderCount} Orders</div>`;

            return starsHtml;
        }

        // ====================================================================
        // === CART MANAGEMENT LOGIC ===
        // ====================================================================

        function updateCartDisplay() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-item-count').textContent = count;
        }

        function saveCart() {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
            updateCartDisplay();
        }

        function addToCart(itemDetails) {
            if (!checkUserLoginStatus()) {
                alert("You must log in to add items to cart.");
                localStorage.setItem('redirectAfterLogin', 'Menu.html');
                window.location.href = LOGIN_PAGE;
                return;
            }

            // Check if product is available
            if (!itemDetails.available) {
                alert(`Sorry, ${itemDetails.name} is currently out of stock.`);
                return;
            }

            const existingItem = cart.find(item => String(item.id) === String(itemDetails.id));

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: itemDetails.id,
                    name: itemDetails.name,
                    price: itemDetails.price,
                    image: itemDetails.image, // Save image path
                    quantity: 1,
                    stockStatus: itemDetails.stockStatus
                });
            }

            saveCart();
            alert(`${itemDetails.name} added to cart!`);
        }

        // Cart modification functions removed (moved to Cart.html)

        // ====================================================================
        // === RENDERING FUNCTIONS ===
        // ====================================================================

        // renderCartModal removed

        function renderBestSellers(products) {
            const container = document.getElementById('bestsellers-content');
            if (!container) return;

            // Sort products by OrderCount (descending) and take top 6
            const bestSellers = [...products]
                .sort((a, b) => (b.OrderCount || 0) - (a.OrderCount || 0))
                .slice(0, 6);

            if (bestSellers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: white; padding: 20px;">No best sellers available.</p>';
                return;
            }

            let html = '';

            bestSellers.forEach(item => {
                const id = item.ProductID;
                const name = item.ProductName;
                const priceDisplay = parseFloat(item.Price).toFixed(2);
                const rawPrice = item.Price;
                const imagePath = item.Image;
                const description = item.Description || '';
                const starRating = item.StarRating || 0;
                const orderCount = item.OrderCount || 0;
                const stockStatus = item.StockStatus || 'available';
                const isAvailable = item.IngredientAvailable;

                // Determine stock badge
                let stockBadge = '';
                let stockClass = '';
                if (stockStatus === 'out_of_stock') {
                    stockBadge = '<span class="stock-badge out-of-stock">Out of Stock</span>';
                    stockClass = 'out-of-stock';
                } else if (stockStatus === 'low_stock') {
                    stockBadge = '<span class="stock-badge low-stock">Low Stock</span>';
                    stockClass = 'low-stock';
                }

                // Generate star rating HTML
                const starsHtml = generateStarRating(starRating, orderCount);

                // Button text and state
                const buttonDisabled = !isAvailable ? 'disabled' : '';
                const buttonText = !isAvailable ? 'Unavailable' : 'Add to Cart';

                html += `
                    <div class="menu-item2 ${stockClass}" data-item-id="${id}"> 
                        ${stockBadge}
                        <div class="item-image-container">
                            <img 
                                src="${imagePath}" 
                                alt="${name}" 
                                class="item-image"
                                onerror="this.onerror=null; this.src='Photo/default-image.jpg';" 
                            >
                        </div>
                        <div class="item-details-container">
                            <div class="item-info2">
                                <div class="item-name">${name}</div>
                                ${starsHtml}
                                <div class="item-description">${description}</div>
                                <div class="item-price">₱${priceDisplay}</div>
                            </div>
                            <button class="add-to-cart-btn" 
                                data-id="${id}" 
                                data-name="${name}" 
                                data-price="${rawPrice}"
                                data-image="${imagePath}"
                                data-available="${isAvailable}"
                                data-stock-status="${stockStatus}"
                                ${buttonDisabled}>
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            setupBestSellersListeners();
        }

        function renderMenu(products) {
            const container = document.getElementById('dynamic-menu-content');
            if (!container) return;

            let menuHtml = '';

            const groupedProducts = groupProductsByCategory(products);

            container.innerHTML = '';

            for (const categoryName in groupedProducts) {
                menuHtml += `
                    <div class="menu-category-container menu-category">
                        <h3>${categoryName}</h3>
                        <div class="menu-grid2">
                `;

                groupedProducts[categoryName].forEach(item => {
                    const id = item.ProductID;
                    const name = item.ProductName;
                    const priceDisplay = parseFloat(item.Price).toFixed(2);
                    const rawPrice = item.Price;
                    const imagePath = item.Image;
                    const description = item.Description || '';
                    const starRating = item.StarRating || 0;
                    const orderCount = item.OrderCount || 0;
                    const stockStatus = item.StockStatus || 'available';
                    const isAvailable = item.IngredientAvailable;

                    // Determine stock badge
                    let stockBadge = '';
                    let stockClass = '';
                    if (stockStatus === 'out_of_stock') {
                        stockBadge = '<span class="stock-badge out-of-stock">Out of Stock</span>';
                        stockClass = 'out-of-stock';
                    } else if (stockStatus === 'low_stock') {
                        stockBadge = '<span class="stock-badge low-stock">Low Stock</span>';
                        stockClass = 'low-stock';
                    }

                    // Generate star rating HTML
                    const starsHtml = generateStarRating(starRating, orderCount);

                    // Button text and state
                    const buttonDisabled = !isAvailable ? 'disabled' : '';
                    const buttonText = !isAvailable ? 'Unavailable' : 'Add to Cart';

                    menuHtml += `
                        <div class="menu-item2 ${stockClass}" data-item-id="${id}"> 
                            ${stockBadge}
                            <div class="item-image-container">
                                <img 
                                    src="${imagePath}" 
                                    alt="${name}" 
                                    class="item-image"
                                    onerror="this.onerror=null; this.src='Photo/default-image.jpg';" 
                                >
                            </div>
                            <div class="item-details-container">
                                <div class="item-info2">
                                    <div class="item-name">${name}</div>
                                    ${starsHtml}
                                    <div class="item-description">${description}</div>
                                    <div class="item-price">₱${priceDisplay}</div>
                                </div>
                                <button class="add-to-cart-btn" 
                                    data-id="${id}" 
                                    data-name="${name}" 
                                    data-price="${rawPrice}"
                                    data-image="${imagePath}"
                                    data-available="${isAvailable}"
                                    data-stock-status="${stockStatus}"
                                    ${buttonDisabled}>
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    `;
                });

                menuHtml += `
                        </div>
                    </div>
                `;
            }

            container.innerHTML = menuHtml;
            setupMenuListeners();
        }

        function updateAccountLink() {
            const accountLink = document.getElementById('account-link');
            const user = JSON.parse(localStorage.getItem(USER_KEY));

            if (user) {
                accountLink.textContent = user.name.split(' ')[0].toUpperCase();
                accountLink.href = PROFILE_PAGE;
            } else {
                accountLink.textContent = 'PROFILE';
                accountLink.href = LOGIN_PAGE;
            }
        }

        // ====================================================================
        // === EVENT LISTENERS ===
        // ====================================================================
        function setupBestSellersListeners() {
            document.querySelectorAll('#bestsellers-content .add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const name = e.target.getAttribute('data-name');
                    const price = parseFloat(e.target.getAttribute('data-price'));
                    const image = e.target.getAttribute('data-image');
                    const available = e.target.getAttribute('data-available') === 'true';
                    const stockStatus = e.target.getAttribute('data-stock-status');

                    addToCart({ id, name, price, image, available, stockStatus });
                });
            });
        }

        function setupMenuListeners() {
            document.querySelectorAll('#dynamic-menu-content .add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const name = e.target.getAttribute('data-name');
                    const price = parseFloat(e.target.getAttribute('data-price'));
                    const image = e.target.getAttribute('data-image');
                    const available = e.target.getAttribute('data-available') === 'true';
                    const stockStatus = e.target.getAttribute('data-stock-status');

                    addToCart({ id, name, price, image, available, stockStatus });
                });
            });
        }

        function setupGlobalListeners() {
            // setupGlobalListeners simplified
            const btn = document.getElementById("view-cart-btn");

            // No modal listeners needed anymore
            // Cart button is now a link, but we can intercept it if needed
            // Currently it wraps an <a> tag so it works natively

            const caterLink = document.getElementById('cater-reservation-link');
            if (caterLink) {
                caterLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    checkLoginAndProceed(CATER_RESERVATION_PAGE);
                });
            }
        }

        // ====================================================================
        // === INITIALIZATION ===
        // ====================================================================

        function updateHeaderElements() {
            updateCartDisplay();
            updateAccountLink();
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchMenuData();
            updateHeaderElements();
            setupGlobalListeners();
        });
    </script>
</body>

</html>