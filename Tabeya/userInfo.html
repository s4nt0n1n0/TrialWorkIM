<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation Information</title>
    <link rel="stylesheet" href="CSS/userInfoDesign.css">
    <style>
        .product-category-nav {
            background-color: rgb(188, 24, 35); 
            position: fixed; 
            top: 0;
            left: 0; 
            right: 0;
            display: flex; 
            justify-content: center; 
            padding: 15px;
            z-index: 50;
            flex-wrap: wrap;
            gap: 5px;
        }
        .product-category-nav a {
            color: white;
            margin: 0 10px;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
        }
        .product-category-nav a:hover,
        .product-category-nav a.active {
            color: yellow;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading-spinner::after {
            content: "";
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #bc1823;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .no-products {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="background">
        <img src="Photo/Reservation.jpg" alt="Background">
        <h1 class="quote">YOUR<br>SATISFACTION<br>IS OUR<br>PASSION</h1>
        <div class="rectangle-panel">
            <h1 class="product-selection-label">CHOOSE YOUR PREFERRED PRODUCTS</h1>
            <div class="continue-section">
                <button class="continue-btn" onclick="initializeProductSelection()">Continue to Product Selection</button>
            </div>
            <div id="product-selection-panel" class="product-selection-panel">
                <div class="product-category-nav">
                    <a href="#" data-category="PLATTER" class="active">Platter</a>
                    <a href="#" data-category="RICE MEAL">Rice Meal</a>
                    <a href="#" data-category="RICE">Rice</a>
                    <a href="#" data-category="NOODLES & PASTA">Bilao</a>
                    <a href="#" data-category="SPAGHETTI MEAL">Spaghetti Meals</a>
                    <a href="#" data-category="SNACKS">Snacks</a>
                    <a href="#" data-category="DESSERT">Dessert</a>
                    <a href="#" data-category="DRINKS & BEVERAGES">Drinks & Beverages</a>
                </div>
                <div id="product-groups" class="product-groups"></div>
                <div class="panel-controls">
                    <div class="total-price-container">
                        Total Price: ₱<span id="total-price">0.00</span>
                    </div>
                    <div>
                        <button class="cancel-btn" onclick="closeProductSelection()">Cancel</button>
                        <button class="submit-btn" onclick="showConfirmationPopup()">Submit Orders</button>
                    </div>
                </div>
            </div>
        </div>
    </div>  

    <div class="popup-overlay" id="confirmation-popup">
        <div class="popup-content">
            <p>Are you sure you want to submit your orders?<br>
            Total Orders: ₱<span id="total-reservation"></span></p>
            <button onclick="confirmReservation()">Yes</button>
            <button onclick="closePopup('confirmation-popup')">No</button>
        </div>
    </div>

    <div class="popup-overlay" id="success-popup">
        <div class="popup-content">
            <p>Orders received! Our staff will contact you shortly to get your delivery address. Thank you for choosing TABEYA!</p>
            <button onclick="redirectToReservation()">Exit to Cater Reservation</button>
        </div>
    </div>

    <script>
    // ====================================================================
    // GLOBAL VARIABLES
    // ====================================================================
    let allProducts = [];
    let selectedProducts = {};
    let totalAmount = 0;

    // ====================================================================
    // INITIALIZE PRODUCT SELECTION
    // ====================================================================
    async function initializeProductSelection() {
        try {
            const productGroups = document.getElementById('product-groups');
            productGroups.innerHTML = '<div class="loading-spinner"></div>';

            const response = await fetch('fetch_products.php');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            if (!data.success) throw new Error(data.message || 'Failed to fetch products');

            allProducts = data.products || [];
            console.log('Products loaded:', allProducts.length);
            console.log('Categories found:', [...new Set(allProducts.map(p => p.Category))]);

            document.body.classList.add('blur-background');
            document.getElementById('product-selection-panel').style.display = 'block';

            // Display default category (PLATTER)
            const defaultProducts = filterProductsByCategory('PLATTER');
            displayProducts(defaultProducts);
            setupCategoryNavigation();

        } catch (error) {
            console.error('Error initializing products:', error);
            alert('Failed to load products. Please try again.\n' + error.message);
        }
    }

    // ====================================================================
    // FILTER PRODUCTS BY CATEGORY (Using actual Category field)
    // ====================================================================
    function filterProductsByCategory(categoryName) {
        return allProducts.filter(product => {
            // Match the Category field from database
            return product.Category && product.Category.toUpperCase() === categoryName.toUpperCase();
        });
    }

    // ====================================================================
    // DISPLAY PRODUCTS
    // ====================================================================
    function displayProducts(products) {
        const productGroups = document.getElementById('product-groups');
        productGroups.innerHTML = '';

        if (products.length === 0) {
            productGroups.innerHTML = '<p class="no-products">No products available in this category.</p>';
            return;
        }

        products.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.classList.add('product-item');

            const savedQuantity = selectedProducts[product.ProductID]?.quantity || 0;
            const price = parseFloat(product.Price);

            productDiv.innerHTML = `
                <div class="product-details">
                    <h3>${product.ProductName}</h3>
                    <p>${product.Description || ''}</p>
                    <p>Price: ₱${price.toFixed(2)}</p>
                </div>
                <div class="product-quantity">
                    <input type="number" min="0" value="${savedQuantity}" 
                           data-price="${price}" 
                           data-id="${product.ProductID}"
                           onchange="updateTotal(this)">
                </div>
            `;
            productGroups.appendChild(productDiv);
        });

        updateDisplayedTotal();
    }

    // ====================================================================
    // SETUP CATEGORY NAVIGATION
    // ====================================================================
    function setupCategoryNavigation() {
        const categoryItems = document.querySelectorAll('.product-category-nav a');
        
        categoryItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                categoryItems.forEach(nav => nav.classList.remove('active'));
                e.target.classList.add('active');

                const categoryName = e.target.dataset.category;
                const filteredProducts = filterProductsByCategory(categoryName);
                displayProducts(filteredProducts);
            });
        });
    }

    // ====================================================================
    // UPDATE TOTAL PRICE
    // ====================================================================
    function updateTotal(input) {
        const productId = input.dataset.id;
        const price = parseFloat(input.dataset.price);
        const quantity = parseInt(input.value) || 0;
        const productName = input.closest('.product-item').querySelector('h3').textContent;

        if (quantity > 0) {
            selectedProducts[productId] = { id: productId, name: productName, price: price, quantity: quantity };
        } else {
            delete selectedProducts[productId];
        }
        updateDisplayedTotal();
    }
    
    function updateDisplayedTotal() {
        totalAmount = 0;
        for (const productId in selectedProducts) {
            const product = selectedProducts[productId];
            totalAmount += product.quantity * product.price;
        }
        document.getElementById('total-price').textContent = totalAmount.toFixed(2);
    }

    // ====================================================================
    // CLOSE / POPUPS / CONFIRM
    // ====================================================================
    function closeProductSelection() {
        document.body.classList.remove('blur-background');
        document.getElementById('product-selection-panel').style.display = 'none';
        selectedProducts = {};
        totalAmount = 0;
        updateDisplayedTotal();
    }

    function showConfirmationPopup() {
        if (Object.keys(selectedProducts).length === 0) {
            alert('Please select at least one product.');
            return;
        }
        document.getElementById('total-reservation').innerText = totalAmount.toFixed(2);
        document.getElementById('confirmation-popup').style.display = 'flex';
    }

    function closePopup(popupId) {
        document.getElementById(popupId).style.display = 'none';
    }

    // ====================================================================
    // CONFIRM AND SAVE RESERVATION
    // ====================================================================
    async function confirmReservation() {
        const selectedProductsList = [];
        for (const productId in selectedProducts) {
            const product = selectedProducts[productId];
            selectedProductsList.push({ id: productId, name: product.name, quantity: product.quantity, price: product.price });
        }

        if (selectedProductsList.length === 0) {
            alert('Please select at least one product.');
            return;
        }

        try {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                alert('User session expired. Please log in again.');
                window.location.href = 'Login.html';
                return;
            }

            const formData = sessionStorage.getItem('cateringFormData');
            if (!formData) {
                alert('Form data not found. Please restart the reservation process.');
                window.location.href = 'CaterReservation.html';
                return;
            }

            const cateringData = JSON.parse(formData);
            const requestBody = new FormData();
            requestBody.append("customer_id", user.customerId || '');
            requestBody.append("customer_name", (user.firstName || '') + " " + (user.lastName || ''));
            requestBody.append("customer_email", user.email || '');
            requestBody.append("customer_phone", user.contactNumber || '');
            requestBody.append("event_date", cateringData.date || '');
            requestBody.append("event_time", cateringData.time || '');
            requestBody.append("guests", cateringData.guests || '1');
            requestBody.append("event_type", cateringData.eventType || '');
            requestBody.append("total_price", totalAmount.toFixed(2));
            requestBody.append("selected_products", JSON.stringify(selectedProductsList));

            const confirmBtn = document.querySelector('#confirmation-popup button:first-of-type');
            confirmBtn.textContent = 'Saving...';
            confirmBtn.disabled = true;

            const response = await fetch('save_product_reservation.php', {
                method: 'POST',
                body: requestBody,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (data.status === 'success') {
                closePopup('confirmation-popup');
                document.getElementById('success-popup').style.display = 'flex';
            } else {
                throw new Error(data.message || 'Unknown error occurred');
            }

        } catch (error) {
            console.error('Error saving reservation:', error);
            alert('An error occurred while saving your reservation:\n' + error.message);
            const confirmBtn = document.querySelector('#confirmation-popup button:first-of-type');
            confirmBtn.textContent = 'Yes';
            confirmBtn.disabled = false;
        }
    }

    function redirectToReservation() {
        sessionStorage.removeItem('cateringFormData');
        window.location.href = "CaterReservation.html";
    }

    // ====================================================================
    // PAGE INITIALIZATION
    // ====================================================================
    document.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) {
            alert('Please log in first.');
            window.location.href = 'Login.html';
            return;
        }
        const formData = sessionStorage.getItem('cateringFormData');
        if (!formData) {
            alert('Please complete the catering form first.');
            window.location.href = 'CaterReservation.html';
        }
    });
    </script>
</body>
</html>
