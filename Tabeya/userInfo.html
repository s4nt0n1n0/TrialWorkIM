<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation Information</title>
    <link rel="stylesheet" href="CSS/userInfoDesign.css">
    <style>
        .product-category-nav {
            background-color: rgb(188, 24, 35); 
            position: fixed; 
            top: 0;
            left: 0; 
            right: 0;
            display: flex; 
            justify-content: center; 
            padding: 15px;
            z-index: 50;
        }

        .product-category-nav a {
            color: white;
            margin: 0 15px;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }
        .product-category-nav a:hover,
        .product-category-nav a.active {
            color: yellow;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .loading-spinner::after {
            content: "";
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Product Selection Section -->
    <div class="background">
        <img src="Photo/Reservation.jpg" alt="Background">
        <h1 class="quote">YOUR<br>SATISFACTION<br>IS OUR<br>PASSION</h1>
        <div class="rectangle-panel">
            <h1 class="product-selection-label">CHOOSE YOUR PREFERRED PRODUCTS</h1>
            <div class="continue-section">
                <button class="continue-btn" onclick="initializeProductSelection()">Continue to Product Selection</button>
            </div>
            <div id="product-selection-panel" class="product-selection-panel">
                <div class="product-category-nav">
                    <a href="#" data-category="1-32" class="active">Bilao</a>
                    <a href="#" data-category="33-54">Platter</a>
                    <a href="#" data-category="55-70">Rice Meal</a>
                    <a href="#" data-category="71-78">Rice</a>
                    <a href="#" data-category="79-86">Spaghetti Meals</a>
                    <a href="#" data-category="87-90">Drink & Beverages</a>
                    <a href="#" data-category="91-94">Snacks</a>
                    <a href="#" data-category="95-98">Dessert</a>
                </div>
                <div id="product-groups" class="product-groups">
                    <!-- Products will be dynamically loaded here -->
                </div>
                
                <div class="panel-controls">
                    <div class="total-price-container">
                        Total Price: ₱<span id="total-price">0.00</span>
                    </div>
                    <div>
                        <button class="cancel-btn" onclick="closeProductSelection()">Cancel</button>
                        <button class="submit-btn" onclick="showConfirmationPopup()">Submit Orders</button>
                    </div>
                </div>
            </div>
        </div>
    </div>  

    <!-- Confirmation Popup -->
    <div class="popup-overlay" id="confirmation-popup">
        <div class="popup-content">
            <p>Are you sure you want to submit your orders?
            Total Orders: ₱<span id="total-reservation"></span>
            </p>
            <button onclick="confirmReservation()">Yes</button>
            <button onclick="closePopup('confirmation-popup')">No</button>
        </div>
    </div>

    <!-- Success Popup -->
    <div class="popup-overlay" id="success-popup">
        <div class="popup-content">
            <p>Orders received! Our staff will contact you shortly to get your delivery address. Thank you for choosing TABEYA!</p>
            <button onclick="redirectToReservation()">Exit to Cater Reservation</button>
        </div>
    </div>

    <script>
    // ====================================================================
    // GLOBAL VARIABLES
    // ====================================================================
    
    let allProducts = [];
    let selectedProducts = {};
    let totalAmount = 0;
    let reservationData = null;

    // ====================================================================
    // INITIALIZE PRODUCT SELECTION
    // ====================================================================
    
    async function initializeProductSelection() {
        try {
            // Show loading
            const productGroups = document.getElementById('product-groups');
            productGroups.innerHTML = '<div class="loading-spinner"></div>';

            // Fetch products
            const response = await fetch('fetch_products.php');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.message || 'Failed to fetch products');
            }

            allProducts = data.products || [];
            console.log('Products loaded:', allProducts.length);

            // Show panel
            document.body.classList.add('blur-background');
            document.getElementById('product-selection-panel').style.display = 'block';

            // Display default category
            const defaultProducts = filterProductsByCategory('1-32');
            displayProducts(defaultProducts);

            // Setup category navigation
            setupCategoryNavigation();

        } catch (error) {
            console.error('Error initializing products:', error);
            alert('Failed to load products. Please try again.\n' + error.message);
        }
    }

    // ====================================================================
    // FILTER PRODUCTS BY CATEGORY
    // ====================================================================
    
    function filterProductsByCategory(categoryRange) {
        const [start, end] = categoryRange.split('-').map(Number);
        return allProducts.filter(product => {
            const productId = parseInt(product.ProductID);
            return productId >= start && productId <= end;
        });
    }

    // ====================================================================
    // DISPLAY PRODUCTS
    // ====================================================================
    
    function displayProducts(products) {
        const productGroups = document.getElementById('product-groups');
        productGroups.innerHTML = '';

        if (products.length === 0) {
            productGroups.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">No products available in this category.</p>';
            return;
        }

        products.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.classList.add('product-item');

            const savedQuantity = selectedProducts[product.ProductID]?.quantity || 0;
            const price = parseFloat(product.Price);

            productDiv.innerHTML = `
                <div class="product-details">
                    <h3>${product.ProductName}</h3>
                    <p>${product.Description || 'High quality catering product'}</p>
                    <p>Price: ₱${price.toFixed(2)}</p>
                </div>
                <div class="product-quantity">
                    <input type="number" min="0" value="${savedQuantity}" 
                           data-price="${price}" 
                           data-id="${product.ProductID}"
                           onchange="updateTotal(this)">
                </div>
            `;
            productGroups.appendChild(productDiv);
        });

        updateDisplayedTotal();
    }

    // ====================================================================
    // SETUP CATEGORY NAVIGATION
    // ====================================================================
    
    function setupCategoryNavigation() {
        const categoryItems = document.querySelectorAll('.product-category-nav a');
        
        categoryItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();

                categoryItems.forEach(nav => nav.classList.remove('active'));
                e.target.classList.add('active');

                const categoryRange = e.target.dataset.category;
                const filteredProducts = filterProductsByCategory(categoryRange);
                displayProducts(filteredProducts);
            });
        });
    }

    // ====================================================================
    // UPDATE TOTAL PRICE
    // ====================================================================
    
    function updateTotal(input) {
        const productId = input.dataset.id;
        const price = parseFloat(input.dataset.price);
        const quantity = parseInt(input.value) || 0;
        const productName = input.closest('.product-item').querySelector('h3').textContent;

        if (quantity > 0) {
            selectedProducts[productId] = {
                id: productId,
                name: productName,
                price: price,
                quantity: quantity
            };
        } else {
            delete selectedProducts[productId];
        }

        updateDisplayedTotal();
    }
    
    // ====================================================================
    // UPDATE DISPLAYED TOTAL
    // ====================================================================
    
    function updateDisplayedTotal() {
        totalAmount = 0;

        for (const productId in selectedProducts) {
            const product = selectedProducts[productId];
            totalAmount += product.quantity * product.price;
        }

        document.getElementById('total-price').textContent = totalAmount.toFixed(2);
    }

    // ====================================================================
    // CLOSE PRODUCT SELECTION
    // ====================================================================
    
    function closeProductSelection() {
        document.body.classList.remove('blur-background');
        document.getElementById('product-selection-panel').style.display = 'none';
        
        // Reset selections
        selectedProducts = {};
        totalAmount = 0;
        updateDisplayedTotal();
    }

    // ====================================================================
    // SHOW CONFIRMATION POPUP
    // ====================================================================
    
    function showConfirmationPopup() {
        const selectedCount = Object.keys(selectedProducts).length;

        if (selectedCount === 0) {
            alert('Please select at least one product.');
            return;
        }

        const totalPrice = totalAmount.toFixed(2);
        document.getElementById('total-reservation').innerText = totalPrice;
        document.getElementById('confirmation-popup').style.display = 'flex';
    }

    // ====================================================================
    // CLOSE POPUP
    // ====================================================================
    
    function closePopup(popupId) {
        document.getElementById(popupId).style.display = 'none';
    }

    // ====================================================================
    // CONFIRM AND SAVE RESERVATION
    // ====================================================================
    
    async function confirmReservation() {
        const selectedProductsList = [];

        for (const productId in selectedProducts) {
            const product = selectedProducts[productId];
            selectedProductsList.push({
                id: productId,
                name: product.name,
                quantity: product.quantity,
                price: product.price
            });
        }

        if (selectedProductsList.length === 0) {
            alert('Please select at least one product.');
            return;
        }

        try {
            // Get user data from localStorage
            const user = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!user) {
                alert('User session expired. Please log in again.');
                window.location.href = 'Login.html';
                return;
            }

            // Get form data from sessionStorage (saved from CaterReservation.html)
            const formData = sessionStorage.getItem('cateringFormData');
            
            if (!formData) {
                alert('Form data not found. Please restart the reservation process.');
                window.location.href = 'CaterReservation.html';
                return;
            }

            const cateringData = JSON.parse(formData);

            // Prepare data for save_product_reservation.php
            const requestBody = new FormData();
            requestBody.append("customer_id", user.customerId || '');
            requestBody.append("customer_name", (user.firstName || '') + " " + (user.lastName || ''));
            requestBody.append("customer_email", user.email || '');
            requestBody.append("customer_phone", user.contactNumber || '');
            requestBody.append("event_date", cateringData.date || '');
            requestBody.append("event_time", cateringData.time || '');
            requestBody.append("guests", cateringData.guests || '1');
            requestBody.append("event_type", cateringData.eventType || '');
            requestBody.append("total_price", totalAmount.toFixed(2));
            requestBody.append("selected_products", JSON.stringify(selectedProductsList));

            // Show loading
            const confirmBtn = document.querySelector('.popup-content button:first-of-type');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = 'Saving...';
            confirmBtn.disabled = true;

            // Send to server
            const response = await fetch('save_product_reservation.php', {
                method: 'POST',
                body: requestBody,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.status === 'success') {
                closePopup('confirmation-popup');
                document.getElementById('success-popup').style.display = 'flex';
                console.log('Reservation saved:', data);
            } else {
                throw new Error(data.message || 'Unknown error occurred');
            }

        } catch (error) {
            console.error('Error saving reservation:', error);
            alert('An error occurred while saving your reservation:\n' + error.message);
        }
    }

    // ====================================================================
    // REDIRECT TO RESERVATION PAGE
    // ====================================================================
    
    function redirectToReservation() {
        // Clear session data
        sessionStorage.removeItem('cateringFormData');
        
        // Redirect
        window.location.href = "CaterReservation.html";
    }

    // ====================================================================
    // PAGE INITIALIZATION
    // ====================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
        // Check if user is logged in
        const user = JSON.parse(localStorage.getItem('currentUser'));
        
        if (!user) {
            alert('Please log in first.');
            window.location.href = 'Login.html';
        }

        // Check if coming from CaterReservation
        const formData = sessionStorage.getItem('cateringFormData');
        
        if (!formData) {
            alert('Please complete the catering form first.');
            window.location.href = 'CaterReservation.html';
        }
    });
    </script>
</body>
</html>